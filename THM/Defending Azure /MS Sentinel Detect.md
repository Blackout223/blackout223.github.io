
# Introduction

We will move on to **threat detection and analytics**, given that we now have seen how to deploy Sentinel, connect data connectors, and how log data is available.

# What Are Analytics Rules

Once Microsoft Sentinel is ready for the organization and log data is being ingested, it is time to dig through all that data to **detect** security threats in the environment.

**Threat detection** in Microsoft Sentinel is made possible by **Analytics rules**.

Microsoft Sentinel security experts provide **analytics rule templates** based on:

- Known threats
- Common attack vectors
- Suspicious activity escalation chains

The alerts generated by Analytics rules create incidents that can then be assigned to and investigated by SOC analysts.

To recap, general Analytics rules flow and timeline are as follows:

- Microsoft Sentinel Analytics rules are the source of **alerts** and **incidents** triggered in your environment
- Using **Analytics rule templates**, specific rule templates are configured and enabled for your environment
- Once an analytics rule is **_enabled_**, based on the rule logic, it starts periodically monitoring the environment  
- Once an analytics rule is **_triggered_**, also with the help of AI-infused correlation, related _"alerts"_ are recorded and grouped into **_"incidents_**"
- These incidents are then triaged by (mostly) SOC Tier-1 analysts

**Do analytics rule templates need to be configured and enabled first in order to detect threats? (Yea/Nay)**

**A: Yea**

**Once "active" Analytics rules are triggered, what is generated in Microsoft Sentinel?**

**A: Alerts**

**Related alerts, with the help of the correlation engine, are recorded and grouped into what?**

**A: Incidents**

# Exploring Analytics Rules

Microsoft Sentinel Analytics plays an important part in the overall detection of security threats by **correlating** and **matching signals**. With a properly configured analytics rule, the following can be identified:

- Where an attack originated from
- What resources were compromised
- Potential data lost
- Timeline for the incident

## Security Analytics Use Cases

|   |
|---|
| Identification of compromised accounts
| **User behaviour analysis -** to detect potentially suspicious patterns
| **Network traffic analysis -** to locate trends indicating potential attacks
| Detection of **Data exfiltration** by Attackers
| Detection of **Insider threats**
| Incident investigation and management
| **Threat hunting**
## Exploring Analytics Rules

![Microsoft Sentinel Analytics interface features a navigation pane on the left with options like Overview, Logs, News & Guides, Search, and threat management tools.Microsoft Sentinel Analytics interface features a navigation pane on the left with options like Overview, Logs, News & Guides, Search, and threat management tools.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737157510708.png)  

1. This is where you see the list of "**Active Rules**", "**Rule Templates**", and "**Anomalies**"
    - **Active Rules:** Rules that are enabled for your environment
    - **Rule Templates:** You can use templates to create an active rule. You need to go through the config wizard to enable the rule
    - **Anomalies:** Unusual behaviours of entities in an environment over a period of time
2. There are **attributes** you can filter the rules with:
    - **Rule Type:** Scheduled, NRT (Near-Real-Time), Fusion, Microsoft Security, ML Behavior Analytics, Threat Intelligence  
        
    - **Data Sources:** Data sources based on which the rule is working on  
        
    - **MITRE Tactics, Techniques**
3. Detailed description of the selected rule and data sources for it

## Rule Types

- **Checkboxes under "Rule type":** All, Scheduled, NRT, Fusion, Microsoft Security, ML Behavior Analytics, Threat Intelligence.
- **Scheduled Rules**
    - Most common rule type.
    - Require defining a specific timing schedule (e.g., every X days/hours/minutes).
    - Run at set intervals to detect patterns or anomalies.
- **Near-Real-Time (NRT) Rules**
    - Used for highly responsive detection scenarios.
    - Run every minute for near-immediate action.
- **Fusion Analytics**
    - Utilizes Microsoft Sentinel’s correlation engine with machine learning.
    - Detects advanced multistage attacks by correlating low-fidelity alerts and events into high-fidelity, actionable incidents.
    - Enabled by default.
- **ML Behavioral Analytics**
    - Based on proprietary Microsoft machine learning algorithms.
    - Internal logic is hidden.
    - Only one rule per template can be created.
- **Microsoft Defender Threat Intelligence (MDTI)**
    - Not customizable.
    - Automatically matches CEF logs, Syslog data, or Windows DNS events with threat indicators (domains, IPs, URLs) from Microsoft Threat Intelligence.
    - Generates high-fidelity alerts.

**Are active rules Analytics rules that are currently running and generating security alerts? (Yea/Nay)**

**A: Yea**

**How often do **Near-Real Time (NRT)** rules run?**

**A: Every Minute**

**Which rule type runs at regular intervals based on specified timing?**

**A: scheduled**

# Analytics Rule Wizard

`Microsoft Sentinel > Analytics > Rule templates > Select a rule template > Create rule`  

![Microsoft Sentinel Analytics shows a list of rule templates, with "User Assigned New Privileged Role" highlighted, marked as high severity and scheduled type.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737040774124.png)

**General**

![Analytics rule wizard - Create a new Scheduled rule' page in Microsoft Sentinel.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737569211672.png)

**Set Rule Logic**

!["Analytics rule wizard - Create a new Scheduled rule" page in Microsoft Sentinel, with the "Set rule logic" tab active. The "Rule query" section features a Kusto Query Language (KQL) query, and below it, a "Query scheduling" section allows users to set the execution frequency.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737156822967.png)

**Incident Settings**

Incident settings is where we can enable/disable incident creation from this rule and apply **alert grouping**.

 Analytics rules generate "alerts" when triggered, not incidents. Incidents are made up of alerts triggered by the rule.

We choose to generate incidents from alerts here, which can be assigned to and analyzed by SOC Tier-1 analysts.

![In Microsoft Sentinel's Analytics rule wizard, the 'Create incidents from alerts' option is enabled, while the 'Group related alerts into incidents' option is disabled.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737157138350.png)

**Automated Response**

This is where we can define the **automation options** (SOAR part of Microsoft Sentinel) as a response to the analytics rule getting triggered.

![In the "Analytics rule wizard - Create a new Scheduled rule" page in Microsoft Sentinel, the "Automated response" tab allows the addition of new automation rules.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737626145380.png)

When the automated response will be applied, are based on the following:

- When an **incident is created/updated**
- When an **alert is created**
![Create new automation rule interface with fields for "Automation rule name," "Trigger," and "Conditions." The "Trigger" dropdown shows options: "When incident is created," "When incident is updated," and "When alert is created."](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737040775359.png)

Finally, **automated response actions** are:

- To **run a playbook**
- To **change status/severity**
- To **assign an owner**
- To **add tags**
- To **add task**

![A dropdown menu titled 'Actions' with six options listed: 'Run playbook,' 'Change status,' 'Change severity,' 'Assign owner,' 'Add tags,' and 'Add task.'](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737626640816.png)

**What is used to customize Analytics rules templates?**

**A: Analytics rule wizard**

**In which part of the wizard can you configure how often the rule will run?**

**A: Query Scheduling**

**Which tab of the wizard serves as the SOAR side of Microsoft Sentinel?**

**A: Automated Response**

# Lab-04: Enable an Analytics Rule

**Context:** Your company recently deployed Microsoft Sentinel. A Data connector is populated and connected. You are tasked to enable an **analytics rule** to start threat detection.

**Role:** You are logged in as:

- Job function role: **Microsoft Sentinel Contributor**
- Log Analytics workspace permissions: **read** and **write**

## Enable an Analytics Rule

- Go to your **Microsoft Sentinel** dashboard and select the available workspace
- Under **Content management**, select **Content hub**
- Search for **Azure Activity** and install it
- Under **Configuration**, select **Analytics**
- Switch to the **Rule templates** tab

<img width="433" height="77" alt="image" src="https://github.com/user-attachments/assets/0c029168-d8e4-47ae-9bfc-21cab94352dc" />

- Search for the "**rare subscription-level operations**" rule

<img width="1098" height="161" alt="image" src="https://github.com/user-attachments/assets/7dd05e4b-eaef-457f-b4ae-0906ea577edf" />

- Select the rule template and click "**Create rule**"

<img width="618" height="617" alt="image" src="https://github.com/user-attachments/assets/4b57b916-daaa-4629-8f3a-26be11667a87" />

- Read the **rule description** for some background context
- Expand the **MITRE ATT&CK** drop-down to see how to map the rule to the different **MITRE Tactics and Techniques**

<img width="208" height="245" alt="image" src="https://github.com/user-attachments/assets/38c0ab38-cdeb-40c4-89b4-d6c5485be105" />

- On the **Set rule logic** tab, read through the **Rule query**  
    - Note the **SensitiveOperationList** array values
    - Also, note that you can easily customize the rule query to your needs by simply modifying the **SensitiveOperationList** array values here

<img width="1348" height="526" alt="image" src="https://github.com/user-attachments/assets/42e4f4fb-b822-4699-8eef-9e9835204513" />

- The **test with current data** shows you a graphical simulation of the rule

<img width="754" height="111" alt="image" src="https://github.com/user-attachments/assets/37cd93e1-1cf2-46ff-be7b-ae449103b7fb" />

- Update the **Query scheduling** to the following:
    - Run query **every 1 hour**
    - Lookup data **from the last 7 days**

<img width="645" height="175" alt="image" src="https://github.com/user-attachments/assets/c2b788e2-6e37-4030-9fb0-250233378b9c" />

- On the **Incident settings** tab:
    - Leave defaults so that **incidents are created** from alerts triggered by this rule.
    - Alert grouping can also be done here to **reduce the noise** from single alert

<img width="684" height="307" alt="image" src="https://github.com/user-attachments/assets/815c1302-0716-4006-96d9-5de4ab3f9ab1" />

- Select **Review + create** to save the rule
- Then, go back to the **Active** **Rules** tab, search for the newly created rule, select it, and click **Edit** on the sidebar

<img width="1556" height="1116" alt="image" src="https://github.com/user-attachments/assets/b80f9361-8479-4ec6-94c4-d8c065cda2ef" />

- Select the **Automated response** tab:
    - Add a **new automation rule**:
        - Rule Name: Tag Rule
        - Trigger: **When** **incident is created**
        - Actions: **Add tags**
            - Tag: subscription
        - Rule expiration: Leave as default
    - Click **Apply**

<img width="1734" height="989" alt="image" src="https://github.com/user-attachments/assets/2804cf20-0a46-4c06-acad-ea5b83eaab74" />

- Finally, **Review and Create** the rule

<img width="878" height="461" alt="image" src="https://github.com/user-attachments/assets/9728b9d8-c560-4910-8569-d01bcbaa1444" />

## Review the Enabled Analytics Rule

- Switch to the **Active rules** tab
- Select the recently saved rule - **Rare subscription-level operations in Azure**
- On the right pane, review the **rule details**, and scroll down to see your settings for:  
    - **Rule frequency**
    - **Rule period**

<img width="495" height="774" alt="image" src="https://github.com/user-attachments/assets/eadabac0-cdf7-4b9d-b4b2-b63bc28cfc58" />

- Click **Compare with template** to see the differences between your settings and the rule template in YAML representation

<img width="1153" height="760" alt="image" src="https://github.com/user-attachments/assets/551def4d-5752-4a7b-82e7-87b871dda1a1" />
